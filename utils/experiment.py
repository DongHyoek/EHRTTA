import torch
import torch.nn as nn
import torch.nn.functional as F
import evaluate
import wandb
import time

from tqdm import tqdm
from torch.utils.data import Dataset, DataLoader
from transformers import AutoConfig, AutoTokenizer, AutoModel, get_cosine_schedule_with_warmup
from accelerate import Accelerator

from models.align import ModalityAlignment
from models.embed import DataEmbedding_ITS, TextEncoder, TextEncoder_v2
from models.llm import PEFTTSLLM
from models.tta import PEFTAdaINPatcher
from utils.norm import TSScaler
from utils.metric import MetricManager

def train(args, trn_loader, val_loader, ckpt_dir, use_load=False):

    # accelerator setting
    if args.cuda:
        accelerator = Accelerator(mixed_precision='bf16', log_with='wandb')
    else:
        accelerator = Accelerator(mixed_precision='bf16', cpu=True, log_with='wandb') # Adaptation, Evaluation mode

    accelerator.init_trackers(project_name="EHRTTA", config=vars(args), 
                              init_kwargs={"wandb": {"name": f"{args.model_id}_{args.seed}_{args.task_label}_{args.data_source}", "tags": ["dora", "retain time series length", "use CLS token for text embeddings", "delete FFN blocks"]}})
    global_step = 0

    device = accelerator.device
    patience = 0
    
    # Define the scaler
    scaler = TSScaler(args)

    # Define architectures
    model = PEFTTSLLM(args, device, adapter_dir=ckpt_dir, use_load=use_load).to(device)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

    ts_embedder = DataEmbedding_ITS(d_model=model.hidden_size, n_var = args.n_time_cols, device=device, 
                                           dropout=args.ts_dropout, use_time=args.use_time, use_ts_pool=args.use_ts_pool).to(device)
    text_encoder = TextEncoder_v2(args, model, use_ln_out=True, device=device).to(device)

    aligner = ModalityAlignment(d_model=model.hidden_size, n_heads=args.align_n_heads, 
                                dropout=args.align_dropout, use_gating=args.use_align_gate).to(device)

    optimizer = torch.optim.AdamW([p for p in model.parameters() if p.requires_grad], lr=args.lr, weight_decay=args.weight_decay)
    
    # Option of using scheduler
    if args.scheduler:
        num_training_steps = len(trn_loader) * args.n_epochs
        scheduler = get_cosine_schedule_with_warmup(optimizer=optimizer, 
                                                    # num_warmup_steps=int(num_training_steps * 0.03),
                                                    num_warmup_steps=50, 
                                                    num_training_steps=num_training_steps)
        
        model, aligner, ts_embedder, text_encoder, optimizer, scheduler, trn_loader, val_loader  = accelerator.prepare(model, aligner, ts_embedder, text_encoder, optimizer, scheduler, trn_loader, val_loader)

    else:
        scheduler = None
        model, aligner, ts_embedder, text_encoder, optimizer, trn_loader, val_loader  = accelerator.prepare(model, aligner, ts_embedder, text_encoder, optimizer, trn_loader, val_loader)

    # initialize the normalization by using source training set
    scaler.reset_source_accum()
    
    for i, batch in enumerate(tqdm(trn_loader, desc='Initialize for the normalization')):
        _, x, mask, _, _, _, _, _ = batch
        x, mask = x.to(device), mask.to(device)
        scaler.update_source(x, mask)

    source_state = scaler.finalize_source()
    
    evaluator = MetricManager(args)
    
    print(f'["dbp", "sbp", "map", "hr", "o2sat", "resp", "temp"]')
    print(f'Source Mean : Shape {source_state["mean"].shape} / Values{source_state["mean"]}')
    print(f'Source Std : Shape {source_state["std"].shape} / Values{source_state["std"]}')

    # Training
    print('Training Start..')
    best_val_loss = 1e9

    for epoch in range(1, args.n_epochs+1):
        print(f'==========[{epoch} / {args.n_epochs}]==========')
        
        running_trn_loss = 0.0
        running_val_loss = 0.0

        evaluator.reset()
        model.train()
        aligner.train()
        ts_embedder.train()
        text_encoder.train()

        for i, batch in enumerate(tqdm(trn_loader, desc='Source Training', total=len(trn_loader))):
            
            tt, x, ts_mask, texts_batch, var_ids_batch, field_ids_batch, y, pids = batch
            tt, x, ts_mask, var_ids_batch, field_ids_batch, y = tt.to(device), x.to(device), ts_mask.to(device), var_ids_batch.to(device), field_ids_batch.to(device), y.to(device)

            with accelerator.autocast():   # <-- 이게 핵심
                # 1) Time series Embedding 
                scaled_x = scaler.transform_source(x, ts_mask)    # 1-1) Time series Scaling
                ts_embedding = ts_embedder(tt, scaled_x, ts_mask) # 1-2) Time series Embedding -> (B, D, L_ts,d_model) 
                
                torch.cuda.synchronize()
                t0 = time.time()

                # Reshape for time series
                B, D, L, d = ts_embedding.shape                     # (B, D, L, d)
                ts_embedding = ts_embedding.reshape(B, D*L, d)      # (B, D * L, d)
                ts_mask = ts_mask.reshape(B, D*L)                   # (B, D*L)
                    
                # 2) Convert text token id to text embedding vectors    
                text_embedding = text_encoder(texts_batch, var_ids_batch, field_ids_batch, x.shape[0], args.te_n_texts) # (B, L_text, d_model)
                # torch.cuda.synchronize()
                # t1 = time.time()

                # 3) Cross modality aligning
                aligned_embedding, cross_attn_weights = aligner(ts_embedding, text_embedding, ts_mask, need_weights=args.align_return_weights) # (B, D*L_ts, d_model)
                # torch.cuda.synchronize()
                # t2 = time.time()

                # 4) input the aligned embedding vector
                outputs = model(inputs_embeds=aligned_embedding, attention_mask=ts_mask, labels=y) # Dict(loss, logits, pooled : [(B, d_model)])
                loss = outputs['loss']
                # torch.cuda.synchronize()
                # t3 = time.time()

                # print("text_enc:", t1-t0, "align:", t2-t1, "llama:", t3-t2)

            # optimizing
            accelerator.backward(loss)
            optimizer.step()
            if args.scheduler:
                scheduler.step()
            optimizer.zero_grad()
            
            running_trn_loss  += loss.item()
            accelerator.log({"Train/loss": loss.item(),
                             "Train/learning_rate" : optimizer.param_groups[0]['lr']}, step=global_step)
            global_step += 1

            logits, gt = accelerator.gather_for_metrics((outputs['logits'], y))

            if args.task == 'classification':
                evaluator.update_classification(logits, gt)
            else:
                evaluator.update_regression(logits, gt)
        
            if i % args.print_iter == 0 and i != 0:
                accelerator.print(f'[Epoch : {epoch},  Iter : {(i + 1):03d} / {len(trn_loader):03d}] Running Loss {running_trn_loss / (i + 1):.3f}')

            torch.save(cross_attn_weights.detach().cpu(), f'{ckpt_dir}/attn_weights_train_{i:04d}.pt')
            torch.save(torch.tensor(pids), f'{ckpt_dir}/pids_train_{i:04d}.pt')

        # Evaluation 
        train_loss = running_trn_loss / len(trn_loader)
        train_metrics = evaluator.compute()

        with torch.no_grad():
            evaluator.reset() # reset for valiadation
            model.eval()
            aligner.eval()
            ts_embedder.eval()
            text_encoder.eval()

            for i, batch in enumerate(tqdm(val_loader, desc='Source Validation', total=len(val_loader))):
                            
                tt, x, ts_mask, texts_batch, var_ids_batch, field_ids_batch, y, pids = batch
                tt, x, ts_mask, var_ids_batch, field_ids_batch, y = tt.to(device), x.to(device), ts_mask.to(device), var_ids_batch.to(device), field_ids_batch.to(device), y.to(device)

                with accelerator.autocast():   # <-- 이게 핵심
                    # 1) Time series Embedding 
                    scaled_x = scaler.transform_source(x, ts_mask)    # 1-1) Time series Scaling
                    ts_embedding = ts_embedder(tt, scaled_x, ts_mask) # 1-2) Time series Embedding -> (B,D,d_model)

                    # Reshape for time series
                    B, D, L, d = ts_embedding.shape                     # (B, D, L, d)
                    ts_embedding = ts_embedding.reshape(B, D*L, d)      # (B, D * L, d)
                    ts_mask = ts_mask.reshape(B, D*L)                   # (B, D*L)

                    # 2) Convert text token id to text embedding vectors    
                    text_embedding = text_encoder(texts_batch, var_ids_batch, field_ids_batch, len(texts_batch), args.te_n_texts)

                    # 3) Cross modality aligning
                    aligned_embedding, cross_attn_weights = aligner(ts_embedding, text_embedding, ts_mask, need_weights=args.align_return_weights) # (B, D, d_model)

                    # 4) input the aligned embedding vector
                    outputs = model(inputs_embeds=aligned_embedding, attention_mask=ts_mask, labels=y) # Dict(loss, logits, pooled : [(B, d_model)])
                    
                running_val_loss  += outputs['loss'].item()
                
                logits, gt = accelerator.gather_for_metrics((outputs['logits'], y))
                
                if args.task == 'classification':
                    evaluator.update_classification(logits, gt)
                else:
                    evaluator.update_regression(logits, gt)

                # torch.save(cross_attn_weights.detach().cpu(), f'{ckpt_dir}/attn_weights_valid_{i:03d}.pt')
                # torch.save(torch.tensor(pids), f'{ckpt_dir}/pids_valid_{i:03d}.pt')

            valid_loss = running_val_loss / len(val_loader)
            valid_metrics = evaluator.compute()
        
        # Logging 
        print(f"====[Epoch {epoch}/{args.n_epochs} ] | Avg. Train Loss: {train_loss:.3f} | Avg. Valid Loss: {valid_loss:.3f}====")
        
        print(f"== Training Results == ")
        accelerator.print({'epoch' : epoch, **train_metrics})

        print(f"== Validation Results == ")
        accelerator.print({'epoch' : epoch, **valid_metrics})

        if args.task == 'classification':
            result = {
                    "Epoch": epoch,
                    "Train/epoch_loss": train_loss,
                    "Valid/epoch_loss": valid_loss,
                    "Valid/auroc": valid_metrics["auroc"],
                    "Valid/auprc": valid_metrics["auprc"],
                    "Valid/f1" : valid_metrics['f1'],
                    "Valid/precision" : valid_metrics['precision'],
                    "Valid/recall" : valid_metrics['recall'],
                    "Valid/accuracy" : valid_metrics["accuracy"],
                    "Valid/confusion_metrix" : valid_metrics["confusion_matrix"],
                    "Train/auroc": train_metrics["auroc"],
                    "Train/auprc": train_metrics["auprc"],
                    "Train/f1" : train_metrics['f1'],
                    "Train/precision" : train_metrics['precision'],
                    "Train/recall" : train_metrics['recall'],
                    "Train/accuracy" : train_metrics["accuracy"],
                    "Train/confusion_metrix" : train_metrics["confusion_matrix"]
                    }
            
            accelerator.log(result, step=global_step)

        else:
            result = {
                    "Epoch": epoch,
                    "Train/epoch_loss": train_loss,
                    "Valid/epoch_loss": valid_loss,
                    "Valid/mse": valid_metrics["mse"],
                    "Valid/mae": valid_metrics["mae"],
                    "Valid/mape" : valid_metrics["mape"],
                    "Train/mse": train_metrics["mse"],
                    "Train/mae": train_metrics["mae"],
                    "Train/mape" : train_metrics["mape"]
                    }
            
            accelerator.log(result, step=global_step)

        if best_val_loss > valid_loss:
            print(f'====[Epoch {epoch}/{args.n_epochs}] | Best Valid Loss update {best_val_loss:.3f} ==> {valid_loss:3f} ====')
            best_val_loss = valid_loss
            save_ckpt(ckpt_dir, ts_scaler=scaler, model=model, ts_embedder=ts_embedder, text_encoder=text_encoder, aligner=aligner, 
                      optimizer=optimizer, scheduler=scheduler, epoch=epoch, best_val_loss=best_val_loss, args=args)
            

        else:
            patience += 1
            
            if args.early_stop:
                if args.patience == patience:
                    print('==== Early Stopping ====')
                    break

    accelerator.end_training()
    print(f'==========[Finish]==========')
    return result

def inference(args, data_loader, ckpt_dir, use_load=True):

    # accelerator setting
    if args.cuda:
        accelerator = Accelerator(mixed_precision='bf16', log_with='wandb')
    else:
        accelerator = Accelerator(mixed_precision='bf16', cpu=True, log_with='wandb') # Adaptation, Evaluation mode

    device = accelerator.device
    
    # Define the scaler
    scaler = TSScaler(args)

    # Define architectures
    model = PEFTTSLLM(args, device, adapter_dir=ckpt_dir, use_load=use_load).to(device)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 

    ts_embedder = DataEmbedding_ITS(d_model=model.hidden_size, n_var = args.n_time_cols, device=device, 
                                           dropout=args.ts_dropout, use_time=True, use_ts_pool=args.use_ts_pool).to(device)
    
    text_encoder = TextEncoder_v2(args, model, use_ln_out=True, device=device).to(device)

    aligner = ModalityAlignment(d_model=model.hidden_size, n_heads=args.align_n_heads, 
                                dropout=args.align_dropout, use_gating=args.use_align_gate).to(device)

    load_misc_ckpt(ckpt_dir=ckpt_dir, model=model, ts_embedder=ts_embedder, text_encoder=text_encoder, aligner=aligner, 
                   ts_scaler=scaler, device=device)
    
    model, aligner, ts_embedder, text_encoder, data_loader  = accelerator.prepare(model, aligner, ts_embedder, text_encoder, data_loader)

    evaluator = MetricManager(args)
    
    evaluator.reset() # reset for valiadation

    print(f'["dbp", "sbp", "map", "hr", "o2sat", "resp", "temp"]')
    print(f'Source Mean : Shape {scaler.source_state["mean"].shape} / Values{scaler.source_state["mean"]}')
    print(f'Source Std : Shape {scaler.source_state["std"].shape} / Values{scaler.source_state["std"]}')

    running_infer_loss = 0

    with torch.no_grad():
        model.eval()
        aligner.eval()
        ts_embedder.eval()
        text_encoder.eval()

        for i, batch in enumerate(tqdm(data_loader, desc='Inference', total=len(data_loader))):
            
            tt, x, ts_mask, texts_batch, var_ids_batch, field_ids_batch, y, pids = batch
            tt, x, ts_mask, var_ids_batch, field_ids_batch, y = tt.to(device), x.to(device), ts_mask.to(device), var_ids_batch.to(device), field_ids_batch.to(device), y.to(device)

            with accelerator.autocast():   # <-- 이게 핵심
                # 1) Time series Embedding 
                scaled_x = scaler.transform_source(x, ts_mask)    # 1-1) Time series Scaling
                ts_embedding = ts_embedder(tt, scaled_x, ts_mask) # 1-2) Time series Embedding -> (B,D,d_model)
                
                # Reshape for time series
                B, D, L, d = ts_embedding.shape                     # (B, D, L, d)
                ts_embedding = ts_embedding.reshape(B, D*L, d)      # (B, D * L, d)
                ts_mask = ts_mask.reshape(B, D*L)                   # (B, D*L)

                # 2) Convert text token id to text embedding vectors    
                text_embedding = text_encoder(texts_batch, var_ids_batch, field_ids_batch, len(texts_batch), args.te_n_texts)


                # 3) Cross modality aligning
                aligned_embedding, cross_attn_weights = aligner(ts_embedding, text_embedding, ts_mask, need_weights=args.align_return_weights) # (B, D, d_model)

                # 4) input the aligned embedding vector
                outputs = model(inputs_embeds=aligned_embedding, attention_mask=ts_mask, labels=y) # Dict(loss, logits, pooled : [(B, d_model)])
                
            running_infer_loss  += outputs['loss'].item()
            
            logits, gt = accelerator.gather_for_metrics((outputs['logits'], y))
            
            if args.task == 'classification':
                evaluator.update_classification(logits, gt)
            else:
                evaluator.update_regression(logits, gt)

        infer_loss = running_infer_loss / len(data_loader)
        infer_metrics = evaluator.compute()
        
        # Logging 
        print(f"====[Inference Results] | Avg. Test Loss: {infer_loss:.3f}====")

        print(f"== Inference Results == ")
        
        accelerator.print({**infer_metrics})

        if args.task == 'classification':
            return {
                    "Inference/avg_loss": infer_loss,
                    "Inference/auroc": infer_metrics["auroc"],
                    "Inference/auprc": infer_metrics["auprc"],
                    "Inference/f1" : infer_metrics['f1'],
                    "Inference/precision" : infer_metrics['precision'],
                    "Inference/recall" : infer_metrics['recall'],
                    "Inference/accuracy" : infer_metrics["accuracy"],
                    "Inference/confusion_metrix" : infer_metrics["confusion_matrix"],
                    }
        else:
            return {
                    "Inference/avg_loss": infer_loss,
                    "Inference/mse": infer_metrics["mse"],
                    "Inference/mae": infer_metrics["mae"],
                    "Inference/mape" : infer_metrics["mape"],
                    }

def adaptation(args, data_loader, ckpt_dir, use_load=True):

    # accelerator setting
    if args.cuda:
        accelerator = Accelerator(mixed_precision='bf16', log_with='wandb')
    else:
        accelerator = Accelerator(mixed_precision='bf16', cpu=True, log_with='wandb') # Adaptation, Evaluation mode

    device = accelerator.device

    # Define architectures
    model = PEFTTSLLM(args, device, adapter_dir=ckpt_dir, use_load=use_load).to(device)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

    ts_embedder = DataEmbedding_ITS(d_model=model.hidden_size, n_var = args.n_time_cols, device=device, 
                                           dropout=args.ts_dropout, use_time=True, use_ts_pool=args.use_ts_pool).to(device)
    
    text_encoder = TextEncoder_v2(args, model, use_ln_out=True, device=device).to(device)

    aligner = ModalityAlignment(d_model=model.hidden_size, n_heads=args.align_n_heads, 
                                dropout=args.align_dropout, use_gating=args.use_align_gate).to(device)
    
    load_misc_ckpt(ckpt_dir=ckpt_dir, model=model, ts_embedder=ts_embedder, text_encoder=text_encoder, aligner=aligner, device=device)

    model, aligner, ts_embedder, text_encoder, data_loader  = accelerator.prepare(model, aligner, ts_embedder, text_encoder, data_loader)

    scaler = TSScaler(args)

    evaluator = MetricManager(args)
    
    evaluator.reset() # reset for valiadation

    running_adapt_loss = 0

    with torch.no_grad():
        model.eval()
        aligner.eval()
        ts_embedder.eval()
        text_encoder.eval()

        for i, batch in enumerate(tqdm(data_loader, desc='Test-Time Adaptation', total=len(data_loader))):
            
            tt, x, ts_mask, texts_batch, var_ids_batch, field_ids_batch, y, pids = batch
            tt, x, ts_mask, var_ids_batch, field_ids_batch, y = tt.to(device), x.to(device), ts_mask.to(device), var_ids_batch.to(device), field_ids_batch.to(device), y.to(device)

            with accelerator.autocast():   # <-- 이게 핵심
                # 1) Time series Embedding 
                scaled_x = scaler.transform_source(x, ts_mask)    # 1-1) Time series Scaling
                ts_embedding = ts_embedder(tt, scaled_x, ts_mask) # 1-2) Time series Embedding -> (B,D, L_ts,d_model)
                
                # Reshape for time series
                B, D, L, d = ts_embedding.shape                     # (B, D, L, d)
                ts_embedding = ts_embedding.reshape(B, D*L, d)      # (B, D * L, d)
                ts_mask = ts_mask.reshape(B, D*L)                   # (B, D*L)

                # 2) Convert text token id to text embedding vectors    
                text_embedding = text_encoder(texts_batch, var_ids_batch, field_ids_batch, len(texts_batch), args.te_n_texts) #(B, L_text, d_model)

                # 3) Cross modality aligning
                aligned_embedding, cross_attn_weights = aligner(ts_embedding, text_embedding, ts_mask, need_weights=args.align_return_weights) # (B, D*L, d_model)

                # 4) input the aligned embedding vector
                outputs = model(inputs_embeds=aligned_embedding, attention_mask=ts_mask, labels=y) # Dict(loss, logits, pooled : [(B, d_model)])
                
            running_adapt_loss  += outputs['loss'].item()
            
            logits, gt = accelerator.gather_for_metrics((outputs['logits'], y))
            
            if args.task == 'classification':
                evaluator.update_classification(logits, gt)
            else:
                evaluator.update_regression(logits, gt)

        adapt_loss = running_adapt_loss / len(data_loader)
        adapt_metrics = evaluator.compute()
        
        # Logging 
        print(f"====[Adaptation Results] | Avg. Test Loss: {adapt_loss:.3f}====")

        print(f"== Adaptation Results == ")
        
        accelerator.print({**adapt_metrics})

        if args.task == 'classification':
            return {
                    "Adaptation/avg_loss": adapt_loss,
                    "Adaptation/auroc": adapt_metrics["auroc"],
                    "Adaptation/auprc": adapt_metrics["auprc"],
                    "Adaptation/f1" : adapt_metrics['f1'],
                    "Adaptation/precision" : adapt_metrics['precision'],
                    "Adaptation/recall" : adapt_metrics['recall'],
                    "Adaptation/accuracy" : adapt_metrics["accuracy"],
                    "Adaptation/confusion_metrix" : adapt_metrics["confusion_matrix"],
                    }
        else:
            return {
                    "Adaptation/avg_loss": adapt_loss,
                    "Adaptation/mse": adapt_metrics["mse"],
                    "Adaptation/mae": adapt_metrics["mae"],
                    "Adaptation/mape" : adapt_metrics["mape"],
                    }
        
def save_ckpt(ckpt_dir, ts_scaler, model, ts_embedder, text_encoder, aligner, optimizer=None, scheduler=None,
              epoch=None, best_val_loss=None, args=None):

    model.backbone.save_pretrained(f'{ckpt_dir}/best_adapter')
    
    ckpt = {
        "ts_scaler_state" : ts_scaler.state_dict(),
        "ts_embedder_state": ts_embedder.state_dict(),
        "text_encoder_state": text_encoder.state_dict(),
        "aligner_state": aligner.state_dict(),
        "head_state": model.head.state_dict(), 
        "epoch": epoch,
        "best_val_loss": best_val_loss,
    }

    if optimizer is not None:
        ckpt["optimizer_state"] = optimizer.state_dict()

    if scheduler is not None:
        ckpt["scheduler_state"] = scheduler.state_dict()

    if args is not None:
        # argparse Namespace면 dict로
        ckpt["args"] = vars(args) if hasattr(args, "__dict__") else args

    torch.save(ckpt, f'{ckpt_dir}/best_misc.pt')
    
    print(f"[CKPT] Saved to : {ckpt_dir}")


def load_misc_ckpt(ckpt_dir, model, ts_embedder, text_encoder, aligner, ts_scaler=None, device='cpu',
                   optimizer=None, scheduler=None, strict=True):
    
    misc = torch.load(f'{ckpt_dir}/best_misc.pt', map_location='cpu')

    ts_embedder.load_state_dict(misc["ts_embedder_state"], strict=strict)
    text_encoder.load_state_dict(misc["text_encoder_state"], strict=strict)
    aligner.load_state_dict(misc["aligner_state"], strict=strict)
    model.head.load_state_dict(misc["head_state"], strict=strict)

    if optimizer is not None and "optimizer_state" in misc:
        optimizer.load_state_dict(misc["optimizer_state"])

    if scheduler is not None and "scheduler_state" in misc:
        scheduler.load_state_dict(misc["scheduler_state"])
    
    if ts_scaler is not None:
        ts_scaler.load_state_dict(misc['ts_scaler_state'], device=device)

    epoch = misc.get("epoch", None)
    best_val_loss = misc.get("best_val_loss", None)

    print(f"[CKPT] Loaded from: {ckpt_dir} (epoch={epoch}, best_val_loss={best_val_loss})")

    return epoch, best_val_loss