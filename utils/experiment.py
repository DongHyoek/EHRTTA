import torch
import torch.nn as nn
import torch.nn.functional as F

from tqdm import tqdm
from torch.utils.data import Dataset, DataLoader
from transformers import AutoConfig, AutoTokenizer, AutoModel
from accelerate import Accelerator

from models.align import ModalityAlignment
from models.embed import DataEmbedding_ITS_Pooled
from models.llm import PEFTTSLLM
from models.tta import PEFTAdaINPatcher
from utils.norm import TSScaler

def train(args, trn_loader, val_loader):

    if args.cuda:
        accelerator = Accelerator(mixed_precision='bf16')
    else:
        accelerator = Accelerator(mixed_precision='bf16', cpu=True) # Adaptation, Evaluation mode

    device = accelerator.device

    # Define architectures
    model = PEFTTSLLM(args, device).to(device)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

    ts_embedder = DataEmbedding_ITS_Pooled(d_model=model.hidden_size, n_var = args.n_time_cols, device=device, 
                                           dropout=args.te_dropout, use_time=True).to(device)

    aligner = ModalityAlignment(d_model=model.hidden_size, n_heads=args.align_n_heads, 
                                dropout=args.align_dropout, use_gating=args.use_align_gate).to(device)

    optimizer = torch.optim.AdamW([p for p in model.parameters() if p.requires_grad], lr=args.lr, weight_decay=args.weight_decay)

    model, aligner, optimizer, trn_loader, val_loader  = accelerator.prepare(model, aligner, optimizer, trn_loader, val_loader)

    # initialize the normalization by using source training set
    scaler = TSScaler(args)
    scaler.reset_source_accum()
    
    for i, batch in enumerate(tqdm(trn_loader, desc='Initialize for the normalization')):
        _, x, mask, _, _, _, _ = batch
        x, mask = x.to(device), mask.to(device)
        scaler.update_source(x, mask)


    source_state = scaler.finalize_source()
    print("Source mean/std ready", source_state["mean"].shape, source_state["std"].shape)

    # Training
    print('Training Start..')
    
    for epoch in range(1, args.n_epochs+1):
        print(f'==========[{epoch} / {args.n_epochs}]==========')
        
        running_trn_loss = 0.0
        running_val_loss = 0.0
        best_val_loss = 1e9

        model.train()

        for i, batch in enumerate(tqdm(trn_loader, desc='Source Training', total=len(trn_loader))):
            
            tt, x, ts_mask, input_ids, text_mask, y, pids = batch
            tt, x, ts_mask, input_ids, text_mask, y = tt.to(device), x.to(device), ts_mask.to(device), input_ids.to(device), text_mask.to(device), y.to(device)

            # 1) Time series Embedding 
            scaled_x = scaler.transform_source(x, ts_mask)    # 1-1) Time series Scaling
            ts_embedding = ts_embedder(tt, scaled_x, ts_mask) # 1-2) Time series Embedding -> (B,D,d_model)
            
            # 2) Convert text token id to text embedding vectors    
            text_embedding = model.backbone.get_input_embeddings()(input_ids) # (B, longest token length, d_model)

            # 3) Cross modality aligning
            aligned_embedding, cross_attn_weights = aligner(ts_embedding, text_embedding, text_mask, args.align_return_weights) # (B, D, d_model)

            # 4) embedding input
            with accelerator.accumulate(model):
                outputs = model(inputs_embeds=aligned_embedding, labels=y) # Dict(loss, logits, pooled : [(B, d_model)])
                
                loss = outputs['loss']

                accelerator.backward(loss)
                optimizer.step()
                optimizer.zero_grad()
                
                running_trn_loss  += loss.item()
                
        
            if i % 100 == 0 and i != 0:
                accelerator.print(f'[Epoch : {epoch},  Iter : {i:.3f} / {len(trn_loader):.3f}] Running Loss {running_trn_loss / i:.3f}')

        train_loss = running_trn_loss / len(trn_loader)

        with torch.no_grad():
            model.eval()

            for i, batch in enumerate(tqdm(val_loader, desc='Source Validation', total=len(val_loader))):
                
                tt, x, ts_mask, input_ids, text_mask, y, pids = batch
                tt, x, ts_mask, input_ids, text_mask, y = tt.to(device), x.to(device), ts_mask.to(device), input_ids.to(device), text_mask.to(device), y.to(device)

                # 1) Time series Embedding 
                scaled_x = scaler.transform_source(x, ts_mask)    # 1-1) Time series Scaling
                ts_embedding = ts_embedder(tt, scaled_x, ts_mask) # 1-2) Time series Embedding -> (B,D,d_model)
                
                # 2) Tokenizing text data  
                text_embedding = model.get_input_embeddings()(input_ids) # (B, longest token length, d_model)

                # 3) Cross modality aligning
                aligned_embedding, cross_attn_weights = aligner(ts_embedding, text_embedding, text_mask, args.align_return_weights) # (B, D, d_model)

                # 4) embedding input
                with accelerator.accumulate(model):
                    outputs = model(inputs_embeds=aligned_embedding, labels=y) # Dict(loss, logits, pooled : [(B, d_model)])
                    running_val_loss  += outputs['loss']

            valid_loss = running_val_loss / len(val_loader)

        print(f"====[Epoch {epoch+1}/{args.epochs} ]| Train Loss: {train_loss:.3f} | Valid Loss: {valid_loss:.3f}====")

        if best_val_loss > valid_loss:
            print(f'====[Epoch {epoch+1}/{args.epochs}] Best Valid Loss update {best_val_loss:.3f} --> {valid_loss:3f} ====')
            model.backbone.save_pretrained(args.save_dir)


def inference(model, data_loader):

    return

def adaptation():

    return

def evaluation():
    return